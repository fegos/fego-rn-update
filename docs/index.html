<!DOCTYPE HTML>
<!--
	Spectral by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>

<head>
  <title>fego-rn-update</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
  <link rel="stylesheet" href="assets/css/main.css" />
  <!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
  <!--[if lte IE 9]><link rel="stylesheet" href="assets/css/ie9.css" /><![endif]-->
  <link rel="apple-touch-icon" sizes="120x120" href="images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <link rel="mask-icon" href="images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

<body class="landing">

  <!-- Page Wrapper -->
  <div id="page-wrapper">

    <!-- Header -->


    <!-- Banner -->
    <section id="banner">
      <div class="inner">
        <h2>fego-rn-update</h2>
        <pre><p>基于React Native(0.47-0.58)的热更新库
提供android和ios两端的支持
支持增量更新，配置简单，部署方便，一键打包
支持字体文件更新
支持拆包下的全量、增量更新
针对apk版本进行更新，支持非强制更新模式
支持设置增量包最大生成数量，限制包生成个数
<a href="http://fe.hhtcex.com/">FEGO大前端团队</a>出品</p></pre>
        <ul class="actions">
          <li>
            <a href="https://github.com/fegos/fego-rn-update" class="button special">download</a>
          </li>
        </ul>
        <!-- <ul class="actions">
								<li><a href="ios/html/index.html" class="button special">iOS</a></li>
							</ul>
							<ul class="actions">
								<li><a href="android/index.html" class="button special">Android</a></li>
							</ul> -->
      </div>
      <a href="#one" class="more scrolly">查看更多</a>
    </section>

    <!-- One -->
    <section id="one" class="wrapper style4">
      <div class="inner">
        <!-- <header class="major">
								<h2>fego-rn-update</h2>
								<p>fego-rn 官方热更新方案<br />
								基于React Native的增量更新库，提供android和ios两端的支持</p>
							</header> -->
        <!-- <div class="inner"> -->
        <h1 id="支持平台">支持平台</h1>
        <ul>
          <li>Android</li>
          <li>iOS</li>
        </ul>
        <h1 id="设计原则">设计原则</h1>
        <ul>
          <li>ios和android两端使用同一套脚本</li>
          <li>打全量包和增量包只需要执行一个脚本即可</li>
          <li>无论拆包还是非拆包，统一使用一套脚本</li>
        </ul>
        <h1 id="API文档">API文档</h1>
        <ul>
          <li>
            <a href="ios/html/index.html">iOS</a>
          </li>
          <li>
            <a href="android/index.html">Android</a>
          </li>
        </ul>
        <h1 id="目录结构">目录结构</h1>
        <ul>
          <li>整体目录结构</li>
        </ul>
        <pre><code>
	├── FegoRnUpdate.podspec    # ios pod库的描述文件
	├── android                 # android原生源码
	├── demo                    # demo示例
	│   ├── App.js              # js主代码
	│   ├── android             # android工程
	│   ├── increment           # 增量包、全量包存储路径
	│   ├── index.js            # js入口文件
	│   ├── ios                 # ios工程
	│   ├── pkg.sh              # 主打包脚本文件
	│   ├── pkgCmd              # 辅助脚本文件夹
	│   └── resource            # 存放字体文件
	├── docs                    # api文档
	├── hybriddemo              # 拆包demo
	│   ├── android             # android工程
	│   ├── ios                 # ios工程
	│   └── rn                  # js相关代码
	├── increment               # 包生成目录
	├── index.js                # js源码
	├── ios                     # ios源码
	├── package.json            # 项目描述文件
	├── pkg.sh                  # 打包文件
	└── pkgCmd                  # 辅助脚本文件夹</code></pre>
        <ul>
          <li>打包脚本目录</li>
        </ul>
        <pre><code>
	├── pkg.sh                  # 整体打包文件，包含全量打包和增量打包，主执行脚本文件
	└── pkgCmd                  # 辅助脚本文件夹
		├── allPkg.sh           # 全量包打包脚本
		├── bundleDiff.js       # 拆包时bundle的diff
		├── config.js           # 配置文件，主要配置生成包的存储位置
		├── incre               # bundle和assets增量生成脚本
		│   ├── assets.js       # 资源assets增量生成脚本
		│   └── jsbundle.js     # bundle增量生成脚本
		├── incregen.js         # 增量包生成脚本
		├── md5.js              # 生成全量更新config
		├── third               # 依赖的第三方脚本
		│   ├── diff_match_patch_uncompressed.js    # 文件差异生成脚本
		│   └── file_list.js    # 列出目录下所有的文件
		├── unpack.js           # 拆包
		└── Utils               # 公共方法</code></pre>
        <h1 id="安装">安装</h1>
        <pre><code>$ npm install fego-rn-update --save</code></pre>
        <h2 id="手动安装">手动安装</h2>
        <h3 id="android">Android</h3>
        <ol type="1">
          <li>把下面几行添加到
            <code>android/setting.gradle</code>
          </li>
        </ol>
        <pre><code>include &#39;:fego&#39;
project(&#39;:fego&#39;).projectDir = new File(rootProject.projectDir, &#39;../node_modules/fego-rn-update/android&#39;)</code></pre>
        <ol start="2" type="1">
          <li>在
            <code>android/build.gradle</code>中更新build工具版本为
            <code>2.2+</code>
          </li>
        </ol>
        <pre><code>buildscript {
	...
	dependencies {
		classpath &#39;com.android.tools.build:gradle:2.2.3&#39;
	}
}
							</code></pre>
        <ol start="3" type="1">
          <li>在
            <code>android/gradle/wrapper/gradle-wrapper.properties</code>中更新gradle版本为
            <code>2.14.1以上</code>
          </li>
        </ol>
        <pre><code>...
distributionUrl=https\://services.gradle.org/distributions/gradle-3.3-all.zip</code></pre>
        <ol start="4" type="1">
          <li>在
            <code>android/app/build.gradle</code>添加依赖</li>
        </ol>
        <pre><code>dependencies {
	compile project(&#39;:fego&#39;)
    	compile "com.squareup.retrofit2:retrofit:2.1.0"
    	compile "com.squareup.retrofit2:converter-gson:2.0.0"
}</code></pre>
        <ol start="5" type="1">
          <li>在
            <code>AndroidManifest.xml</code>中添加依赖</li>
        </ol>
        <pre><code>&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;</code></pre>
        <ol start="6" type="1">
          <li>初始化
            <code>ReactManager</code>
          </li>
        </ol>
        <pre><code>ReactManager.getInstance().init(getApplication(), "index", "index.jsbundle", "https://raw.githubusercontent.com/fegos/fego-rn-update/master/demo/increment/android/");</code></pre>
        <ol start="7" type="1">
          <li>生成
            <code>ReactRootView</code>时，需要使用ReactManager中生成的
            <code>RnInstanceManager</code>
          </li>
        </ol>
        <pre><code>String businessName = "";
if (mReactRootView == null) {
	mReactRootView = new ReactRootView(this);
	if (mReactInstanceManager == null) {
		if (ReactManager.getInstance().getRnInstanceManager() == null) {
			List<ReactPackage> reactPackages = new ArrayList<>();
			// 添加额外的package
			reactPackages.add(new HotUpdatePackage());
			ReactManager.getInstance().loadBundle(reactPackages, BuildConfig.DEBUG, "");
		}
		mReactInstanceManager = ReactManager.getInstance().getRnInstanceManager();
	}
	mReactRootView.startReactApplication(mReactInstanceManager, "hotUpdate", null);
	setContentView(mReactRootView);
}</code></pre>
        <ol start="8" type="1">
          <li>调用热更新代码（也可js端调用）</li>
        </ol>
        <pre><code>String businessName = "";
SuccessListener sucListener;// 一般是activity实现了该接口，可以为null，为null时表示不交给用户处理，而是内部默认解压加载
FailListener failListener;	// 一般是activity实现了该接口，可以为null
ReactManager.getInstance().loadBundleBehind(businessName, sucListener, failListenr);</code></pre>
        <ol start="9" type="1">
          <li>处理结果通知</li>
        </ol>
        <ul>
          <li>默认全部更新，不需做任何其他处理</li>
        </ul>
        <ul>
          <li>可以分别实现
            <code>SuccessListener</code>、
            <code>FailListener</code>，来处理成功和失败的情况</li>
        </ul>
        <pre><code>@Override
public void onSuccess() {
	questionUpdateReactSource();// 可以弹窗提示
}
						
protected void questionUpdateReactSource() {
	//此处标记已经下载了新的rn资源包,提示用户是否进行更新
	AlertDialog dialog = new AlertDialog.Builder(this)
			.setTitle("温馨提示")
			.setMessage("有新的资源包可以更新，是否立即更新?")
			.setNegativeButton("取消", new DialogInterface.OnClickListener() {
				@Override
				public void onClick(DialogInterface dialog, int which) {
					dialog.cancel();
				}
			})
			.setPositiveButton("确定", new DialogInterface.OnClickListener() {
				@Override
				public void onClick(DialogInterface dialog, int which) {
					ReactManager.getInstance().unzipBundle();
					ReactManager.getInstance().doReloadBundle();
					// 下次启动应用时更新
					// ReactManager.getInstance().unzipBundle();
				}
			})
			.create();
	dialog.show();
}
						
@Override
public void onFail(ReactManager.NPReactManagerTask task) {
	if (task == ReactManager.NPReactManagerTask.GetConfigFail) {
		// 获取config失败
	} else if (task == ReactManager.NPReactManagerTask.GetSourceFail) {
		// 获取zip包失败
	} else if (task == ReactManager.NPReactManagerTask.Md5VerifyFail) {
		// md5验证失败
	}
}</code></pre>
        <p>
          <strong>注意</strong>:
          <p>如果实现了SuccessListener，则不会解压新包，也不会自动加载最新bundle，所有成功后的操作需要自行实现，可以调用下面的方法进行重新加载</p>
        </p>
        <pre><code>String businessName = "";
// 仅解压包，不执行下面的操作时下次启动自动更新
ReactManager.getInstance().unzipBundle(businessName);
// 加载新bundle
ReactManager.getInstance().doReloadBundle(businessName);</code></pre>
        <h3 id="ios">IOS</h3>
        <ol type="1">
          <li>pod库引入热更新库，Podfile中添加：</li>
        </ol>
        <pre><code>pod &#39;FegoRnUpdate&#39;</code></pre>
        <ol start="2" type="1">
          <li>工程目录下执行pod命令:</li>
        </ol>
        <pre><code>pod update</code></pre>
        <ol start="3" type="1">
          <li>调用热更新代码</li>
        </ol>
        <pre><code>NIPRnManager *manager = [NIPRnManager sharedManager];
manager.delegate = self;
manager.bundleUrl = @"https://raw.githubusercontent.com/fegos/fego-rn-update/master/demo/increment/ios/increment";
manager.noHotUpdate = NO;
manager.noJsServer = YES;
[manager requestRCTAssetsBehind];
				</code></pre>
        <ol start="4" type="1">
          <li>处理结果通知</li>
        </ol>
        <pre><code>-(void)successHandlerWithFilePath:(NSString *)filePath{
	NSLog(@"NIPHotReloadSuccess");
	[[NIPRnManager sharedManager] unzipBundle:filePath];
	[self loadRnController];
}
-(void)failedHandlerWithStatus:(HotReloadStatus)status{
	switch (status) {
		case NIPReadConfigFailed:
		{
			NSLog(@"NIPReadConfigFailed");
		}
		break;
		case NIPDownloadBundleFailed:
		{
			NSLog(@"NIPDownloadBundleFailed");
		}
		break;
		case NIPMD5CheckFailed:
		{
			NSLog(@"NIPMD5CheckFailed");
		}
		break;
		default:
		break;
	}
}</code></pre>
        <ol start="5" type="1">
          <li>AppDelegate中添加热更新代码的例子</li>
        </ol>
        <pre><code>#import &quot;NIPRnManager.h&quot;
							
- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions
{
	self.window = [[UIWindow alloc] initWithFrame:[[UIScreen mainScreen] bounds]];
	[self loadRnController];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(loadRnController) name:@"RNHotReloadRequestSuccess" object:nil];

  	return YES;
}
- (void)loadRnController {
	/**
	@param bundleUrl 服务器存放bundle的地址
	@param noHotUpdate 用来标记只使用工程自带的rn包，不支持热更新 default:NO
	@param noJsServer 不通过本地启动的server来获取bundle，直接使用离线包 default:NO
	@param moduleName 默认main bundle的指定模块
	*/
	NIPRnController *controller = [[NIPRnManager managerWithBundleUrl:@&quot;bundle下载路径&quot; noHotUpdate:NO noJsServer:YES] loadControllerWithModel:@&quot;moduleName&quot;];
	
	#pragma clang diagnostic push
	#pragma clang diagnostic ignored &quot;-Wincompatible-pointer-types&quot;
	self.window.rootViewController = controller;
	#pragma clang diagnostic pop
}</code></pre>
        <h1 id="使用">使用</h1>
        <ol type="1">
          <li>
            <p>将
              <code>node_modules/fego-rn-update/</code>下
              <code>pkdCmd文件夹</code>和
              <code>pkg.sh</code>文件拷贝到与
              <code>node_modules同级目录</code>下</p>
          </li>
          <li>
            <p>在想要生成包的地方创建包存储目录（其内部是android和ios目录均是自动生成的）</p>
          </li>
        </ol>
        <p>存储目录可以参考
          <code>node_modules/fego-rn-update/</code>下的
          <code>increment文件夹</code>
        </p>
        <pre><code>
	├── React-Native 热更新目录
	├── android             	# 存放android生成的包
	│   └── businessName		# 如果是拆包的情况，会多这一级目录，非拆包的情况，不存在这一级目录
	│   	├── all             # 存放全量包
	│       │   ├── README.md   
	│       │   └── temp		# 该目录为自动生成，存放解压后的包，该目录可添加到.gitignore文件中
	│    	├── config			# 最终的config，该文件会自动生成，默认为增量
	│       └── increment       # 存放增量包
	│           └── README.md
	└── ios                 	# 存放ios生成的包
		└── businessName
			├── all             # 存放全量包
			│   └── README.md
			│   └── temp		# 该目录为自动生成，存放解压后的包，该目录可添加到.gitignore文件中
			├── config			# 最终的config，该文件会自动生成，默认为增量
			└── increment       # 存放增量包
				└── README.md</code></pre>
        <ol start="3" type="1">
          <li>修改配置文件
            <code>config.js</code>中的
            <code>path</code>、
            <code>apkVer</code>、
            <code>bundleName</code>、
            <code>maxGenNum</code>（config.js文件位于pkgCmd/下）
          </li>
          <p>path：生成包存储路径 sdk：跟apk版本号一致</p>
        </ol>
        <pre><code>// 写个用户名跟路径对应的字典，这个方便一个工程多个人维护使用，支持mac
let map = {
	/**
	 * 注意：
	 * 1、username为电脑用户名；
	 * 2、path为包存储位置，末尾需要加“/”，否则会报路径错误
	 */
	username1: 'path1',
	username2: 'path2'
}
// 获取系统信息
let os = require(&#39;os&#39;);
// 获取本机当前用户名
let username = os.userInfo().username;
console.log(map[username]);
module.exports = {
	path: map[username], // 在此处可以直接更改为自己要生成包的位置
	apkVer: &#39;1.0&#39;, // 需跟apk版本保持一致
	bundleName: &#39;index.jsbundle&#39;, // 需跟原生中保持一致
	maxGenNum: &#39;2&#39; // 增量包生成最大数量
}</code></pre>
        <ol start="4" type="1">
          <li>更新字体文件</li>
          <p>需在
            <code>pkg.sh</code>同级目录下创建resource，并将ttf文件存放于该目录下，如果有businessName，则需要多创建一层businessName目录，再将相应的ttf文件放置相应的文件夹中，
          </p>
        </ol>
        <p>
          <strong>注意</strong>:
          <pre><code>不同的业务的ttf命名需不同</code></pre>
        </p>
        <ol start="5" type="1">
          <li>在
            <code>node_modules同级目录</code>下执行脚本
            <code>pkg.sh</code>
          </li>
        </ol>
        <pre><code># platform 平台 ，android或ios，不设置则默认两端都进行生成包操作
# type 更新类型，increment或all，默认为increment，如果type设置了，则说明要更换更新类型，否则默认是去生成包；该属性默认是在生成完好包之后再进行该操作
# businessName 业务名为no，标明不区分业务模块，否则即拆包模式，根据业务名去生成包
sh pkg.sh platform type businessName</code></pre>
        <p>
          <strong>注意</strong>:
          <pre><code>+ 首次运行，因为只生成一个包，故会提示没有新包，不会生成增量包；
+ 运行之后需要在android和ios两个工程中均放置一份解压后的包，android放在`assets/rn/`下，ios放于`项目名/rn/`下（目录若需调整，需要修改原生代码，建议不修改），每次app大版本变化时需要进行该操作；
+ 之后在同一sdk版本下继续运行该脚本时，会进行增量包生成。
+ 生成包之后，需要上传到服务器，用于原生更新时请求，此时的地址就是上面需要在原生中配置的sourceUrl
+ 如果想更换更新方式，可以执行带type参数的脚本，此时会选择将全量还是增量更新的config拷贝到platform/config（此config才是真正的更新config），默认使用的增量模式</code></pre>
        </p>
        <ol start="6" type="1">
          <li>在原生修改几处
            <ul>
              <li>启动文件名字为
                <code>index.js</code>
              </li>
            </ul>
            <ul>
              <li>bundle名字为
                <code>index.jsbundle</code>
              </li>
            </ul>
            <ul>
              <li>请求地址
                <code>config请求地址（如demo中，请求地址为https://raw.githubusercontent.com/fegos/fego-rn-update/master/demo/increment/android/increment/， ios平台只需替换地址中的android即可，ios无需加末尾的‘/’）</code>
              </li>
            </ul>
          </li>
        </ol>
        <p>
          <code>android</code>：在MainActivity中修改</p>
        <p>
          <code>ios</code>：在AppDelegate中修改</p>
        <p>
          <strong>注意</strong>：
          <pre><code>+ android和ios需要统一启动文件名称，均为index.js，否则需要修改全量打包脚本；
+ bundle名字也需要两端统一为index.jsbundle，否则需要修改增量更新打包脚本</code></pre>
        </p>
        <ol start="7" type="1">
          <li>js端调用</li>
        </ol>
        <pre><code>import FegoRNUpdate from &#39;fego-rn-update&#39;
							
class App extends Component {
	render() {
		return (
			&lt;View style={styles.container}&gt;
				&lt;TouchableHighlight
					underlayColor=&quot;transparent&quot;
					onPress={() =&gt; {
						FegoRNUpdate.hotReload(businessName);
					}}&gt;
					&lt;Text style={styles.btnText}&gt;热更新测试&lt;/Text&gt;
				&lt;/TouchableHighlight&gt;
			&lt;/View&gt;
		);
	}
}

const styles = StyleSheet.create({
	container: {
		flex: 1,
		justifyContent: &#39;center&#39;,
		alignItems: &#39;center&#39;,
		backgroundColor: &#39;#F5FCFF&#39;,
	},
	btnText: {
		color: &#39;blue&#39;,
		fontSize: 16
	}
});
							</code></pre>
        <h1 id="欢迎贡献">欢迎贡献</h1>
        <p>有任何疑问或问题欢迎在
          <a href="https://github.com/fegos/fego-rn-update/issues">github issues</a>里提问</p>
        <!-- </div> -->
      </div>
    </section>

    <!-- Footer -->
    <footer id="footer">
      <ul class="icons">
        <li>
          <a href="https://github.com/fegos/fego-rn-update" class="icon fa-github">
            <span class="label">Twitter</span>
          </a>
        </li>
        <li>
          <a href="http://fe.hhtcex.com/" class="icon fa-home">
            <span class="label">Facebook</span>
          </a>
        </li>
        <li>
          <a href="https://github.com/fegos/fego-rn-update/issues" class="icon fa-question">
            <span class="label"></span>
          </a>
        </li>
      </ul>
      <ul class="copyright">
        <li>Copyright ©
          <a href="http://fe.hhtcex.com/">FEGO大前端团队</a>
        </li>
      </ul>
    </footer>

  </div>

  <!-- Scripts -->
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/jquery.scrollex.min.js"></script>
  <script src="assets/js/jquery.scrolly.min.js"></script>
  <script src="assets/js/skel.min.js"></script>
  <script src="assets/js/util.js"></script>
  <!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
  <script src="assets/js/main.js"></script>

</body>

</html>